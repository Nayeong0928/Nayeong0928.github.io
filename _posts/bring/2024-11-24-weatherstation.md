---
title: WeatherStation 구조 변경 (3) DB 저장 & 캐시 도입
author: qoskdud0928
date: 2024-11-24
category: bring
layout: post
---

### 메모리에 올라오는 날씨 객체의 개수 

observer 객체의 수가 3800 * 24 * (스케줄 수) 로 스케줄의 개수에 비례하여 늘어난다는 
단점은 해결되었지만 여전히 3800 * 24 개, 즉 91,200개의 객체가 메모리에 올라오는 것이다.

원래 장소의 수가 그렇게까지 크지 않을 거라고 생각했었기 때문에 날씨 정보를 DB가 아닌 메모리에 
저장해놓기로 했던 것이기 때문에 구조가 고민되었다. 
더군다나 날씨 api로 데이터를 불러오는 시점에는 기존에 있던 데이터와 새로 갱신된 데이터까지 합쳐서 
91200*2개의 객체가 메모리에 올라오는 것이다. 이 시점에서 OOM이 발생하지 않도록 DB에 저장하기로 결심했다. 


### 날씨 데이터의 특성 

그렇지만 한번 들어오면 다음 api를 요청하기 전까지 변화하지 않는 날씨 데이터의 장점은 그대로 살리고 싶었다. 
사용자 한 명이 A장소의 n시의 날씨 정보를 조회했다면 다음 사용자부터는 A장소의 n시 날씨 정보가 필요할 때 
굳이 DB를 조회할 필요가 없다.

또한 사용자가 많아서 3800개의 장소에 모두 스케줄이 등록되어 있다면 몰라도 
그렇게까지 사용자가 많지 않은 초기 단계에서는 3800개의 장소에 대한 날씨 정보가 전부 메모리에 올라올 가능성이 
적다고 판단했다. 

그래서 캐시를 도입해서, 필요한 장소-시간의 날씨 정보만 캐시에 저장하는 방식을 사용하기로 했다. 

